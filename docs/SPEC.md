# SPEC.md - こころのしるべ 詳細仕様書

## 目次

1. [サービス概要](#1-サービス概要)
2. [機能仕様](#2-機能仕様)
   - [A. 日記機能](#a-日記機能)
   - [B. 夢記録・夢占い機能](#b-夢記録夢占い機能)
   - [C. ウィッシュリスト機能](#c-ウィッシュリスト機能)
   - [D. 振り返り機能](#d-振り返り機能)
   - [E. 認証・ユーザー管理](#e-認証ユーザー管理)
   - [F. データ管理](#f-データ管理)
3. [デザイン・UI仕様](#3-デザインui仕様)
4. [技術仕様](#4-技術仕様)

---

## 1. サービス概要

### サービス名
**こころのしるべ**

### コンセプト
心の道標となるサービス。日記で感情を整理し、夢占いで心を読み解き、ウィッシュリストで未来へ導く。

### 目的
- 日々の良かったこと・悪かったことを記録して後から振り返る
- ウィッシュリストで人生を豊かにする
- AIを活用して記録・振り返りを効率化

### ターゲット
- 主に30代の男女
- 初期は個人利用

---

## 2. 機能仕様

### A. 日記機能

#### A-0. 日付選択

| 操作 | 説明 |
|------|------|
| 左右矢印 | 前日/翌日に移動 |
| 日付タップ | カレンダーポップアップを表示、任意の日付を選択可能 |

**制約**: 未来の日付は選択不可（当日まで）

#### A-1. 入力方法

| 方法 | 説明 |
|------|------|
| テキスト入力 | 通常のテキストエリアでの入力 |
| 音声入力 | Web Speech APIによる音声認識 → 文字起こし |

#### A-2. 音声整形機能

**タイミング**: 文字起こし表示後、「整形する」ボタンで実行

**整形レベル**（ユーザーが設定画面で選択）:

| レベル | 説明 | 例 |
|--------|------|-----|
| 軽め | 「えーと」除去、句読点追加のみ | 今日は朝から調子悪くて、でも午後からちょっと元気出てきて、夜は友達とご飯行ってきました。楽しかったです。 |
| しっかり | 文章として読みやすく再構成 | 今日は朝から体調が優れなかったが、午後から回復してきた。夜は友達と食事に行き、楽しい時間を過ごせた。 |
| 箇条書き | 極力短く簡潔に箇条書き化 | ・朝から体調不良<br>・午後に回復<br>・夜は友達と食事、楽しかった |

**設定画面**: 各整形レベルのサンプルを表示

#### A-3. AI自動生成（日記保存時）

| 生成内容 | 説明 |
|----------|------|
| 感情タグ | AIが日記内容から自由にタグを生成 |
| 一行要約 | タイムライン表示用の一行要約 |

**要約更新**:
- 「要約更新」ボタンで手動更新可能
- 最終更新日時を保存し、変更なければAPIを叩かない
- ツールチップで機能説明を表示

---

### B. 夢記録・夢占い機能

#### B-0. 日付選択

| 操作 | 説明 |
|------|------|
| 左右矢印 | 前日/翌日に移動 |
| 日付タップ | カレンダーポップアップを表示、任意の日付を選択可能 |

**制約**: 未来の日付は選択不可（当日まで）

#### B-1. 入力方法

| 方法 | 説明 |
|------|------|
| テキスト入力 | 通常のテキストエリアでの入力 |
| 音声入力 | 日記と同じ整形機能を使用 |

#### B-2. キーワードタグ

- AIが夢の内容からキーワードを自動抽出
- ユーザーは確認・編集可能
- 例: [海] [追いかけられる] [友人]

#### B-3. 夢占い機能

**占いスタイル**（ユーザーが設定画面で選択）:

| スタイル | 特徴 |
|----------|------|
| ユング派 | 成長・自己実現にフォーカス。集合的無意識、元型を重視 |
| フロイト派 | 深層心理・欲求にフォーカス。抑圧された願望を重視 |
| 認知的アプローチ | 現実との接続、実用的なアドバイス。日中の出来事との関連を重視 |

**占い結果**: 総合メッセージのみ

**保存ルール**:
1. 夢の記録を先に保存
2. 「占う」ボタンで占いAPIコール
3. 結果を追記（API失敗しても夢の記録は残る）

**再占い**: 可能、結果は上書き保存

#### B-4. 固有名詞登録

夢占いの精度向上のため、夢に出てくる人物などを事前登録

| 項目 | 必須/任意 |
|------|----------|
| 名前 | 必須 |
| 説明 | 必須 |

例:
```
名前: 田中さん
説明: システム開発を行う会社の同僚。いつも優しく私のことを気にかけてくれる方。
```

#### B-5. API制限

| 項目 | 内容 |
|------|------|
| 制限対象 | 夢占いAPIコール |
| 制限数 | 1日20回まで |
| カウント | ユーザー × 日付ごとに保存 |
| リセット | 毎日0時（JST） |
| 将来拡張 | 有料プランで上限引き上げ |

---

### C. ウィッシュリスト機能

#### C-1. 基本項目

| 項目 | 必須/任意 | 説明 |
|------|----------|------|
| タイトル | 必須 | ウィッシュの名前 |
| 説明 | 任意 | 詳細な説明 |
| 実施可能条件 | 任意 | 最大2つ（OR結合） |
| 目標期限 | 任意 | いつまでに実施したいか |
| ステータス | 自動 | 未達成/達成可能/達成済み |

#### C-2. 実施可能条件

**登録可能な属性**:

| カテゴリ | 属性 |
|----------|------|
| 金銭・資産系 | 年収、貯金額、投資資産額、月の可処分所得、借金・ローン残高 |
| 時間・ライフステージ系 | 年齢（自動計算）、子供の年齢、勤続年数、有給残日数、退職フラグ |
| 健康・自己投資系 | 体重、資格取得状況 |
| 人間関係・状況系 | 配偶者/パートナー有無、居住地、役職 |

**比較演算子**: 以上 / 以下 / 等しい

**条件の組み合わせ**:
- 最大2つまで
- OR結合（条件1 または 条件2）
- 目標期限は条件とは別枠で設定

**条件UI例**:
```
実施可能条件:
  条件1: [貯金額] [以上] [500] 万円
  OR
  条件2: [年収] [以上] [800] 万円

目標期限: 2027年12月まで
```

---

### D. 振り返り機能

#### D-1. カレンダー表示

**表示形式**: 月表示

**セルの表示要素**:

| 要素 | 表示 | 意味 |
|------|------|------|
| 感情絵文字 | 😊😐😢など | 日記あり（感情タグから表示） |
| ● | ドット | 日記あり（感情タグ未生成時） |
| 🌙 | 月アイコン | 夢あり |
| 🎉 | お祝いアイコン | ウィッシュリスト達成あり |

**詳細表示**:
- PC: ホバーで要約をツールチップ表示
- スマホ: タップでポップオーバー表示

#### D-2. タイムライン表示

**表示内容**:
- 日記・夢の両方を表示
- 感情絵文字付き
- 一行要約を表示

**スクロール**: 無限スクロール

**年月ナビゲーター**: 
- PCはサイドバー、スマホはフローティングボタンで呼び出し
- 年月をクリックでその月へジャンプ（Google Photos風）

**詳細表示**: スライドパネル（右から開く）

#### D-3. 検索・フィルタ

| フィルタ | 説明 |
|----------|------|
| キーワード | 本文・要約から全文検索 |
| 期間 | 日付範囲指定（デフォルト: 2025/1/1〜今日） |
| 種類 | 日記のみ / 夢のみ / 両方 |
| 感情タグ | AIが付けたタグで絞り込み |
| 夢キーワード | 夢のキーワードタグで絞り込み |

**UI**: 詳細フィルタは折りたたみで普段はシンプルに

#### D-4. 追加機能（追加実装フェーズ）

- 統計ダッシュボード
- エクスポート範囲指定

---

### E. 認証・ユーザー管理

#### E-1. 認証方式

Googleログインのみ

#### E-2. 初期登録フロー

| 項目 | 必須/任意 | 補足 |
|------|----------|------|
| 生年月日 | 必須 | 「ウィッシュリストの条件判定に利用するため、正確に入力してください」と補足表示 |
| ニックネーム | 任意 | 表示名 |
| 夢占いスタイル | 任意 | デフォルト: ユング派 |
| 音声整形レベル | 任意 | デフォルト: 軽め |

#### E-3. 設定画面

| カテゴリ | 設定項目 |
|----------|----------|
| プロフィール | ニックネーム、生年月日 |
| 記録設定 | 音声整形レベル（サンプル表示付き） |
| 夢占い設定 | 占いスタイル選択 |
| 固有名詞管理 | 登録一覧、追加・編集・削除 |
| 条件用属性管理 | 年収、貯金額などの登録一覧 |
| データ管理 | CSVエクスポート、アカウント削除 |
| アカウント | ログアウト |

---

### F. データ管理

#### F-1. CSVエクスポート（追加実装フェーズ）

**対象**: 日記、夢記録、ウィッシュリスト（ユーザーが選択）

**日記CSV列**:
```
date, content, summary, emotion_tags, created_at, updated_at
```

**夢記録CSV列**:
```
date, content, keyword_tags, fortune_result, fortune_style, created_at, updated_at
```

**ウィッシュリストCSV列**:
```
title, description, conditions, deadline, status, achieved_at, created_at, updated_at
```

#### F-2. アカウント削除

全データ削除 + アカウント抹消

---

## 3. デザイン・UI仕様

### 3-1. 基本方針

| 項目 | 内容 |
|------|------|
| UIライブラリ | shadcn/ui |
| 基調 | 白基調で清潔感 |
| 背景 | three.jsでアニメーション |

### 3-2. 背景アニメーション

| ページ | 背景タイプ |
|--------|------------|
| 基本（日記、ホームなど） | グラデーション（ゆっくり色が変化） |
| 夢記録ページ | 星空・夜空（星がまたたく） |

### 3-3. ナビゲーション

**PC**: サイドバー
**スマホ**: ボトムナビ

**ボトムナビ構成**:

| 位置 | アイコン | ラベル | 画面 |
|------|----------|--------|------|
| 左1 | 📝 | 日記 | 日記記録 |
| 左2 | 🌙 | 夢 | 夢記録 |
| 中央 | 🏠 | ホーム | ホーム |
| 右2 | 📅 | 振り返り | カレンダー/タイムライン |
| 右1 | ⭐ | 願い | ウィッシュリスト |

**ホームへのアクセス**:
- ボトムナビ中央のホームボタン
- ヘッダーのロゴクリック

**設定へのアクセス**: 各画面右上に⚙️アイコン

### 3-4. ホーム画面構成

```
┌─────────────────────────────────────────┐
│ おはようございます、◯◯さん            │
│ 2025年1月25日（土）                     │
├─────────────────────────────────────────┤
│                                         │
│ 【今日の記録】                          │
│ ┌─────────────┐ ┌─────────────┐        │
│ │ 📝 日記     │ │ 🌙 夢       │        │
│ │ [書く]      │ │ [書く]      │        │
│ └─────────────┘ └─────────────┘        │
│                                         │
│ 【今週の記録状況】                      │
│ 日 月 火 水 木 金 土                    │
│ 😊 😐 ●  😢 😊 🌙  --                   │
│                                         │
│ 【ウィッシュリスト】                    │
│ 🔔 「沖縄旅行」の期限まであと30日       │
│ ✨ 「貯金500万」達成まであと12万円      │
│                                         │
└─────────────────────────────────────────┘
```

### 3-5. 画面一覧

| 画面 | パス | 説明 |
|------|------|------|
| LP | / | ランディングページ（SEO対応） |
| ログイン | /login | Googleログイン |
| ホーム | /app/home | ダッシュボード |
| 日記記録 | /app/diary | 日記の入力・編集 |
| 夢記録 | /app/dream | 夢の入力・編集・占い |
| カレンダー | /app/calendar | カレンダー表示 |
| タイムライン | /app/timeline | タイムライン表示 |
| ウィッシュリスト | /app/wishlist | 一覧・追加・編集 |
| 設定 | /app/settings | 各種設定 |

---

## 4. 技術仕様

### 4-1. 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js（App Router） |
| 言語 | TypeScript |
| レンダリング | LP: SSG（SEO対応）/ ログイン後: CSR |
| DB | Supabase（PostgreSQL） |
| 認証 | Supabase Authentication（Google OAuth） |
| Storage | 現時点では不使用 |
| LLM | Anthropic API（Claude） |
| 音声入力 | Web Speech API（ブラウザ標準） |
| UIライブラリ | shadcn/ui |
| アニメーション | three.js |
| ホスティング | Vercel |
| 環境 | 本番 + ローカルの2環境 |

### 4-2. 将来のアプリ化

PWA対応 → Capacitorでネイティブアプリ化

### 4-3. SEO対応

LPのみSSGでSEO対応:
- meta title / description
- OGP（SNSシェア用）
- 構造化データ（JSON-LD）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-01-25 | 初版作成 |
